\chapter{設計}
\label{chap:design}
本章では、まずWeb-Snapshotシステム全体の構成について述べる。
ついで、クライアントであるiOSアプリケーション・Chrome拡張機能の設計について説明する。
そして、サーバ側のデータベース設計およびAPI設計を示す。

\section{全体の構成}
本研究で提案するWeb-Snapshotシステムは、ユーザが触れるインターフェイスであるクライアントと、サーバから構成される。

クライアントは、iOSアプリケーションとChrome拡張機能に分かれている。
それぞれのクライアントアプリケーションは、認証モジュール・ブックマーク保存モジュール・一覧モジュール・閲覧状態復元モジュールの4つのモジュールから成る。

サーバ側は、ユーザのブックマークデータを保存するためのデータベースサーバと、それらのデータを操作するアプリケーションサーバから成る。
アプリケーションサーバはクライアントが利用するためのWebAPIを提供する。
APIは以下の3種類のAPIを持つ。
\begin{enumerate}
   \item 認証関連API
   \item コンテンツ関連API
   \item フォルダ関連API
\end{enumerate}

図\ref{fig:design-system-overall}に本システムの全体像を示す。

\begin{figure}[htbp]
  \caption{システム全体像}
  \label{fig:design-system-overall}
  \begin{center}
    \includegraphics[bb=0 0 592 681,width=15cm]{img/040_design/design-system-overall.pdf}
  \end{center}
\end{figure}

\section{クライアント側設計}
本節では、クライアントを構成する4つのモジュールについて述べる。

\subsubsection{認証モジュール}
認証モジュールでは、ユーザの新規登録とログイン機能を提供する。
ユーザの認証情報はサーバに保存するため、ユーザは複数の端末から本アプリケーションを利用できる。

\subsubsection{ブックマーク保存モジュール}
ブックマーク保存モジュールでは、ユーザがブラウザで閲覧しているWebコンテンツをサーバに保存する。

ユーザがブックマークを作成したタイミングで、Webコンテンツに対してJavaScriptコードを実行する。その際に、WebコンテンツのタイトルやURLといった基本情報に加えて、スクロール位置や動画再生位置といったような閲覧状態に関する情報を取得する。
取得した情報はサーバのデータベースに保存される。

ブックマーク保存モジュールで取得・保存するデータとその用途を表\ref{tb:design-save-bookmark-data-usage}に示す。

% textlint-enable
\begin{table}[htbp]
  \label{tb:design-save-bookmark-data-usage}
  \caption{ブックマーク保存モジュールで取得・保存するデータとその用途}
  \begin{center}
    \begin{tabular}{|l|l|}
      \hline
      保存するデータ & 用途 \\\hline\hline
      URL & ブックマーク機能実現 \\\hline
      ページタイトル & ブックマーク機能実現 \\\hline
      保存時のスクロール位置(横) & 閲覧状態復元 \\\hline
      保存時のスクロール位置(縦) & 閲覧状態復元 \\\hline
      保存時のページ長(横) & 閲覧状態復元 \\\hline
      保存時のページ長(縦) & 閲覧状態復元 \\\hline
      保存時のズーム率 & 閲覧状態復元 \\\hline
      保存時のブラウザ & 閲覧状態復元 \\\hline
      保存時の動画再生位置 & 閲覧状態復元 \\\hline
    \end{tabular}
  \end{center}
\end{table}
% textlint-enable

\subsubsection{一覧モジュール}
一覧モジュールでは、前項のブックマーク保存モジュールで保存したブックマークを一覧する画面を提供する。
表示されているブックマークをタップすると、ブックマーク閲覧状態復元モジュールに遷移し、保存時の閲覧状態を引き継いでコンテンツを閲覧できる。
本モジュールでは、ブックマークの削除やお気に入り登録、任意のフォルダの作成およびコンテンツの整理が可能である。

\subsubsection{閲覧状態復元モジュール}
閲覧状態復元モジュールでは、ユーザが保存したブックマークをブラウザ上で表示し、保存時の閲覧状態を復元する。
ブックマークが読み込まれたタイミングでJavaScriptコードを実行し、ブックマーク保存モジュールで取得したデータに基づいて閲覧状態を復元する。
スクロール位置は、保存時と復元時のブラウザや画面サイズ、ズーム率等の情報から再計算する。結果として得られたスクロール位置を、HTMLのAPIを利用してページに反映させることで、閲覧状態を復元する。
動画や音声の再生位置は、HTMLのAPIを利用して設定する。
PDFのページ数については、サーバ側でURLのフラグメントにページ数を付与しているため、そのURLをそのまま開くことで復元できる。

\section{サーバ側設計}
本節では、サーバのデータベース設計およびAPI設計について説明する。加えて、PDFからページ数を抽出する機能の設計について述べる。

\subsection{データベース設計}
本システムのデータベースにはユーザの認証情報を格納するUserテーブル・ユーザがブックマークしたWebコンテンツを保存するContentテーブル・ユーザが作成したフォルダ情報を格納するFolderテーブル・コンテンツとフォルダを紐付けるためのContentFolderテーブルが存在する。
Userテーブルの項目・カラム名・データ型・値の説明を表\ref{tb:design-user-table}に、Contentテーブルを表\ref{tb:design-content-table}に、Folderテーブルを表\ref{tb:design-folder-table}に、ContentFolderテーブルを表\ref{tb:design-content-folder-table}に示す。

% textlint-disable
\begin{table}[htbp]
  \label{tb:design-user-table}
  \caption{Userテーブル}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      カラム名 & データ型 & 値の説明 \\\hline\hline
      id & bigint & ユーザの識別子 \\\hline
      email & varchar & メールアドレス \\\hline
      encrypted\_password & varchar & 暗号化したパスワード \\\hline
      reset\_password\_token & varchar & パスワードリセット時に用いる時限トークン \\\hline
      reset\_password\_sent\_at & timestamp & パスワードリセットメールを送った日時 \\\hline
      remember\_created\_at & timestamp & 最後のログインした日時 \\\hline
      created\_at & timestamp & 会員登録日時 \\\hline
      updated\_at & timestamp & ユーザ情報更新日時 \\\hline
      provider & varchar & 認証に利用した外部サービス \\\hline
      uid & varchar & 認証に用いるユーザ識別子 \\\hline
      tokens & text & 認証に用いるトークン \\\hline
    \end{tabular}
  \end{center}
\end{table}

\begin{table}[htbp]
  \label{tb:design-content-table}
  \caption{Contentテーブル}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      カラム名 & データ型 & 値の説明 \\\hline\hline
      id & bigint & ブックマークの識別子 \\\hline
      title & varchar & タイトル \\\hline
      content\_type & varchar & ブックマークの種類(WEB,動画,PDFなど) \\\hline
      url & varchar & URL \\\hline
      sharing\_url & varchar & 共有用URL \\\hline
      file\_url & varchar & ファイルの保存先URL \\\hline
      thumbnail\_img\_url & varchar & サムネイル画像のURL \\\hline
      scroll\_position\_x & integer & 保存時のスクロール位置(横) \\\hline
      scroll\_position\_y & integer & 保存時のスクロール位置(縦) \\\hline
      max\_scroll\_position\_x & integer & 保存時のページ長(横) \\\hline
      max\_scroll\_position\_y & integer & 保存時のページ長(縦) \\\hline
      video\_playback\_position & integer & 保存時の動画再生位置 \\\hline
      delete\_flag & boolean & 論理削除フラグ \\\hline
      created\_at & timestamp & 作成日時 \\\hline
      updated\_at & timestamp & 更新日時 \\\hline
      deleted\_at & timestamp & 論理削除日時 \\\hline
      liked & boolean & お気に入り \\\hline
      user\_id & bigint & ブックマークを保存したユーザの識別子 \\\hline
    \end{tabular}
  \end{center}
\end{table}

\begin{table}[htbp]
  \label{tb:design-folder-table}
  \caption{Folderテーブル}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      カラム名 & データ型 & 値の説明 \\\hline\hline
      id & bigint & フォルダの識別子 \\\hline
      name & varchar & フォルダ名 \\\hline
      user\_id & bigint & フォルダを作成したユーザの識別子 \\\hline
    \end{tabular}
  \end{center}
\end{table}

\begin{table}[htbp]
  \label{tb:design-content-folder-table}
  \caption{ContentFolderテーブル}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      カラム名 & データ型 & 値の説明 \\\hline\hline
      id & bigint & コンテンツとフォルダのペアの識別子 \\\hline
      content\_id & bigint & コンテンツの識別子 \\\hline
      folder\_id & bigint & フォルダの識別子 \\\hline
    \end{tabular}
  \end{center}
\end{table}
% textlint-enable

\subsection{API設計}
本システムのサーバ側では、認証関連API・コンテンツ関連API・フォルダ関連APIの三種類のWebAPIを提供している。
本APIはREST\cite{rest}の思想に基づいて設計しており、HTTPリクエストを通じて呼び出すことができる。
REST(REpresentational State Transfer)とは、Roy Fielding氏が2000年に発表したWebAPIのインターフェイスの設計アーキテクチャである\cite{}。

\subsubsection{認証関連API}
認証関連APIは、ユーザの認証情報に関連するAPIを提供する。
認証関連APIが提供する各APIのエンドポイントと概要を表\ref{tb:design-auth-api}に示す。

% textlint-enable
\begin{table}[htbp]
  \label{tb:design-auth-api}
  \caption{認証関連APIエンドポイント一覧}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      HTTPメソッド & パス & 概要 \\\hline\hline
      POST & /v1/auth & 会員登録 \\\hline
      POST & /v1/auth/sign\_in & ログイン \\\hline
      GET & /v1/auth/google & Googleアカウントで認証 \\\hline
      GET & /v1/auth/google/callback & Googleの認証後にリダイレクトされるエンドポイント \\\hline
      GET & /v1/auth/twitter & Twitterアカウントで認証 \\\hline
      GET & /v1/auth/twitter/callback & Twitterの認証後にリダイレクトされるエンドポイント \\\hline
      GET & /v1/auth/github & GitHubアカウントで認証 \\\hline
      GET & /v1/auth/github/callback & GitHubの認証後にリダイレクトされるエンドポイント \\\hline
    \end{tabular}
  \end{center}
\end{table}
% textlint-enable

上記のうち、会員登録するためのリクエストの例を\ref{auth-request-curl}に示す。
レスポンスの例を\ref{auth-response-json}に示す。

% textlint-disable
\begin{itembox}[l]{会員登録リクエストの例}
  \label{auth-request-curl}
  \begin{verbatim}
    curl -X POST --header 'Content-Type: application/json'
     --header 'Accept: application/json' -d '{
      "password": "password",
      "password_confirmation": "password_confirmation",
      "email": "email"
    }' 'https://web-shiori.herokuapp.com/v1/auth'
  \end{verbatim}
\end{itembox}

\begin{itembox}[l]{会員登録リクエストのレスポンス例}
  \label{auth-response-json}
  \begin{verbatim}
    200 OK
    {
      "status": "success",
      "data": {
        "id": 126,
        "provider": "email",
        "uid": "example@example.com",
        "allow_password_change": false,
        "email": "example2@example.com",
        "created_at": "2019-05-12T20:48:24.000+09:00",
        "updated_at": "2019-05-12T20:48:24.000+09:00"
      }
    }
  \end{verbatim}
\end{itembox}
% textlint-enable

\subsubsection{コンテンツ関連API}
認証関連APIは、ユーザがブックマークしたコンテンツを操作するためのAPIを提供する。
コンテンツ関連APIが提供する各APIのエンドポイントと概要を表\ref{tb:design-content-api}に示す。

% textlint-enable
\begin{table}[htbp]
  \label{tb:design-content-api}
  \caption{コンテンツ関連APIエンドポイント一覧}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      HTTPメソッド & パス & 概要 \\\hline\hline
      GET & /v1/content & ブックマークしたコンテンツ一覧取得 \\\hline
      POST & /v1/content & コンテンツをブックマークする \\\hline
      PUT & /v1/content/\{content\_id\} & コンテンツを修正する \\\hline
      DELETE & /v1/content/\{content\_id\} & ブックマークを解除する \\\hline
    \end{tabular}
  \end{center}
\end{table}
% textlint-enable

上記のうち、コンテンツをブックマークするためのリクエストの例を\ref{content-request-curl}に示す。
レスポンスの例を\ref{content-response-json}に示す。

% textlint-disable
\begin{itembox}[l]{コンテンツをブックマークするリクエストの例}
  \label{content-request-curl}
  \begin{verbatim}
    curl -X POST --header 'Content-Type: application/json' 
    --header 'Accept: application/json' 
    --header 'access-token: access-token' 
    --header 'client: client' 
    --header 'uid: uid' -d '{
      "title": "Web-Shioriデモ動画",
      "url": "https://www.youtube.com/watch?v=1DcjMwkmNvA",
      "video_playback_position": 50,
      "scroll_position_x": 0,
      "scroll_position_y": 200,
      "max_scroll_position_x": 0,
      "max_scroll_position_y": 10000
    }' 'https://web-shiori.herokuapp.com/v1/content'
  \end{verbatim}
\end{itembox}

\begin{itembox}[l]{コンテンツをブックマークするリクエストのレスポンス例}
  \label{content-response-json}
  \begin{verbatim}
    200 OK
    {
      "data": {
        "id": 126,
        "content_type": "web",
        "title": "Web-Shioriデモ動画",
        "url": "https://www.youtube.com/watch?v=1DcjMwkmNvA",
        "sharing_url": "https://www.youtube.com/watch?v=1DcjMwkmNvA",
        "file_url": "string",
        "thumbnail_img_url": "https://web-shiori.com/sample.jpg",
        "scroll_position_x": 0,
        "scroll_position_y": 500,
        "max_scroll_position_x": 0,
        "max_scroll_position_y": 1000,
        "video_playback_position": 50,`
        "liked": true,
        "delete_flag": false,
        "deleted_at": "2015-07-20T15:49:04-07:00",
        "created_at": "2019-05-12T20:48:24.000+09:00",
        "updated_at": "2019-05-12T20:48:24.000+09:00"
      }
    }
  \end{verbatim}
\end{itembox}
% textlint-enable

\subsubsection{フォルダ関連API}
フォルダ関連APIは、コンテンツを整理するためのフォルダに関連するAPIを提供する。
フォルダ関連APIが提供する各APIのエンドポイントと概要を表\ref{tb:design-folder-api}に示す。

% textlint-enable
\begin{table}[htbp]
  \label{tb:design-folder-api}
  \caption{フォルダ関連APIエンドポイント一覧}
  \begin{center}
    \begin{tabular}{|l|l|l|}
      \hline
      HTTPメソッド & パス & 概要 \\\hline\hline
      GET & /v1/folder & フォルダ一覧取得 \\\hline
      POST & /v1/folder & フォルダ作成 \\\hline
      PUT & /v1/folder/\{folder\_id\} & フォルダ更新 \\\hline
      DELETE & /v1/folder/\{folder\_id\} & フォルダ削除 \\\hline
      GET & /v1/folder/\{folder\_id\}/content & フォルダ内コンテンツ一覧取得 \\\hline
      POST & /v1/folder/\{folder\_id\}/content/\{content\_id\} & フォルダにコンテンツを追加 \\\hline
      DELETE & /v1/folder/\{folder\_id\}/content/\{content\_id\} & フォルダからコンテンツを削除 \\\hline
    \end{tabular}
  \end{center}
\end{table}
% textlint-enable

\subsection{PDFからページ数を抽出する機能}
本項では、Webブラウザ上で閲覧中のPDFからページ数を抽出・保存する機能の設計について説明する。

Chrome等のブラウザが提供するPDFビューワーには、ページ数を取得するためのAPIが存在しない。
そのため、スクロール位置などのようにJavaScriptコードを通じて取得できない。

そこで、本システムではユーザの画面のキャプチャを保存し、OCRを用いてそのキャプチャから閲覧中のPDFのページ数を取得する、という方法を提案する。

Webブラウザが提供するPDFビューワには、図\ref{fig:pdf-viewer-nav-bar-page-num}のようにナビゲーションバーに現在ユーザが閲覧しているページ数を表示する機能がある。
画面のキャプチャからこの数値を抽出することで、閲覧中のPDFのページ数を取得できる。
本機能の処理の流れを図\ref{fig:design-pdf-page-num-extract}に示す。

\begin{figure}[htbp]
  \caption{PDFビューワのナビゲーションバーに表示されるページ数}
  \label{fig:pdf-viewer-nav-bar-page-num}
  \begin{center}
    \includegraphics[bb=0 0 1440 900,width=15cm]{img/040_design/pdf-viewer-nav-bar-page-num.pdf}
  \end{center}
\end{figure}

\begin{figure}[htbp]
  \caption{PDFのページ数を取得する処理の流れ}
  \label{fig:design-pdf-page-num-extract}
  \begin{center}
    \includegraphics[bb=0 0 511 61,width=15cm]{img/040_design/design-pdf-page-num-extract.pdf}
  \end{center}
\end{figure}

サーバ側では、取得したページ数をURLのフラグメントに付与し、専用のカラムに保存する。
クライアントではこのURLを利用してページを開くことで、PDFのページ数を復元できる。

\section{まとめ}
本章では、Web-Snapshotシステムの設計について述べた。次章では、本システムの実装について述べる。
