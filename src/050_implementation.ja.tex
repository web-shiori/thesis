\chapter{実装}
\label{chap:implementation}
本章では、Web-Snapshotシステムの実装について述べる。
はじめに実装環境について述べ、ついでクライアント側実装、サーバ側実装について説明する。

\section{実装環境}
本節では、本システムの実装環境について説明する。

クライアントの実装は、iOSアプリケーションはSwift、Chrome拡張機能はTypeScript/HTML/CSSを用いて実装した。

サーバ側は、WebAPIの実装にはRuby on Railsを使用し、Heroku\cite{}というPaaSにデプロイして運用している。データベースにはPostgreSQLを採用している。
PDFからページ数を抽出する機能については、Go言語で記述されたAWS LambdaからTextract\cite{}のAPIを呼び出している。

表\ref{tb:implementation-env}は実装環境の詳細である。

\begin{table}[htbp]
  \label{tb:implementation-env}
  \caption{実装環境}
  \begin{center}
    \begin{tabular}{|l|l|l|}
    \hline
    名目 & 使用技術 & バージョン \\ \hline
    実装言語 & Swift & n \\ \hline
    IDE & Xcode & n \\ \hline
    実装言語 & TypeScript & n \\ \hline
    実装言語 & HTML & n \\ \hline
    実装言語 & SCSS & n \\ \hline
    実装言語 & Ruby & n \\ \hline
    フレームワーク & Ruby on Rails & n \\ \hline
    RDBMS & PostgreSQL & n \\ \hline
    PaaS & Heroku & n \\ \hline
    実装言語 & Golang & n \\ \hline
    クラウドコンピューティングサービス & AWS Lambda & n \\ \hline
    ストレージ & AWS S3 & n \\ \hline
    OCR & AWS Textract & n \\ \hline
    \end{tabular}
  \end{center}
\end{table}

\section{クライアント側実装}
クライアントはiOSアプリケーションおよびChrome拡張機能であり、それぞれ主にSwift、TypeScriptによって実装した。
それぞれのアプリケーションについて、認証モジュール・ブックマーク保存モジュール・ブックマーク一覧モジュール・ブックマークの閲覧状態を復元するモジュールの4つのモジュールについて説明する。

\subsection{iOSアプリケーション実装}
本節では、iOSアプリケーションの実装について述べる。図\ref{}にiOSアプリケーションの実装の全体像を示す。
iOSアプリケーションでは、基本的な復元及び動画・音声の復元の2種類の復元に対応している。

\subsubsection{認証モジュール}
本項では、認証モジュールについて説明する。
ユーザが本アプリケーションを開くと、図\ref{}のような画面が表示される。この画面の”登録”ボタンを押すと図\ref{}が開き、会員登録できる。
会員登録のためには、メールアドレスとパスワードを入力する方法と、外部サービスを通じて登録する方法の2種類から選ぶことができる。

メールアドレスで登録するには、図\ref{}でメールアドレスとパスワードを入力する。
ユーザが必要な情報を入力した上で”登録”ボタンを押すと、AuthenticationViewControllerがサーバにデータを送信する。
会員登録が完了すると、サーバは認証に用いるトークンをヘッダに含めてレスポンスを返す。
AuthenticationViewControllerでは、取得したアクセストークンをKeyChain\cite{}に保存する。
ヘッダにこのアクセストークンを付与してリクエストを送信することで、サーバが提供するAPIを利用できるようになる。

外部サービスを通じてログインする場合は、図\ref{}の下部にあるボタンをクリックする。
例として、”Twitterで続ける”ボタンを押すと、図\ref{}のようにTwitter\cite{}の認証画面が開く。
本画面でTwitterアカウントにログインし、本アプリケーションとの連携を許可すると、OAuthの仕組みを利用して本アプリケーションに登録できる。

一度会員登録すると、以後アプリケーションを利用する際は自動でログインされる。
なお、iOSアプリケーションは会員登録せずとも利用できる。その場合、ブックマークのデータは端末内のストレージに保存される。

\subsubsection{ブックマーク保存モジュール}
本項ではブックマーク保存モジュールについて説明する。
ブックマーク保存モジュールはユーザがブックマークしたいWebページのデータと閲覧状態を取得し、サーバに保存するモジュールである。
iOSアプリケーションでは、ブックマークの保存は標準のブラウザであるSafariから行う。
ユーザがブックマークしたいWebページを開いた状態で図\ref{}のような共有ボタンを押すと、共有機能に対応したアプリケーションのアイコンが並んで表示される。
この中から本アプリケーションのアイコンをクリックすると、図\ref{}のような確認用ポップアップが表示される。
ここで”保存”ボタンを押すと、Webコンテンツのデータの取得およびサーバへの保存が実行される。

上記の機能の実装にはAppleが提供しているShareExtension\cite{}を利用している。
ShareExtentionとは、Appleが提供するAppExtension\cite{app-extension}の1つで、任意のアプリケーション内のデータを開発者が提供するアプリケーションに共有できるAPIである。
ユーザが"保存"ボタンを押したタイミングで、ブラウザ上でJavaScriptコードを実行し、Webページのデータと閲覧状態を表すデータを取得する。
表\ref{tb:ios-data-js-api}に、JavaScriptで取得するデータと取得するために用いるAPIをまとめる。
なお、動画の再生位置はWebページ内のDOMにおいて一番初めに位置する動画のデータを取得する。Webページ内に動画が存在しない場合、ゼロ値は0である。

\begin{table}[htbp]
  \label{tb:ios-data-js-api}
  \caption{ブックマーク保存モジュールで取得するデータ}
  \begin{center}
    \begin{tabular}{|l|l|l|}
    \hline
    取得するデータ & 型 & API \\ \hline
    URL & String & document.URL \\ \hline
    ページタイトル & String & ca \\ \hline
    スクロール位置(縦) & Int & document.documentElement.scrollTop \\ \hline
    スクロール位置(横) & Int & document.documentElement.scrollLeft \\ \hline
    ページ長(縦) & Int & document.documentElement.scrollHeight \\ \hline
    ページ長(横) & Int & document.documentElement.scrollWidth \\ \hline
    動画再生位置 & Int & document.getElementsByTagName('video')[0].currentTime \\ \hline
    サムネイル画像URL & String & ca \\ \hline
    ズーム率 & Int & ca \\ \hline
    \end{tabular}
  \end{center}
\end{table}


ShareExtensionを通じて取得したデータは、iOSアプリケーション内のShareViewControllerというコントローラーに渡される。
ShareViewControllerは、取得したデータにいくつかのメタデータを付け加え、サーバに送信する。
ShareViewControllerが付与するメタデータは表\ref{tb:ios-meta-data}の通りである。

\begin{table}[htbp]
  \label{tb:ios-meta-data}
  \caption{ShareViewControllerが付与するメタデータ}
  \begin{center}
    \begin{tabular}{|l|l|}
    \hline
    サーバに送る値 & 型 \\ \hline
    ブラウザの種類 & String \\ \hline
    \end{tabular}
  \end{center}
\end{table}

図\ref{}にiOSアプリケーションにおけるブックマーク保存モジュールの全体像を示す。

\subsubsection{一覧モジュール}
本項ではブックマーク一覧モジュールについて説明する。
一覧モジュールでは、前項のブックマーク保存モジュールで保存したブックマークを一覧できる。
ユーザが本アプリケーションを開くと、サーバからユーザの保存したブックマークを取得する。サーバからのレスポンスとデータの概要を表\ref{tb:ios-bookmark-response}に示す。
取得したデータからタイトル・URL・保存日時・サムネイル画像を抽出し、図\ref{}のようにカード型で一覧表示する。

\begin{table}[htbp]
  \label{tb:ios-bookmark-response}
  \caption{サーバから取得するブックマークのデータ}
  \begin{center}
    \begin{tabular}{|l|l|}
    \hline
    取得する値 & 概要 \\ \hline
    id & 識別子 \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル \\ \hline
    タイトル & Webページのタイトル。 \\ \hline
    \end{tabular}
  \end{center}
\end{table}

ユーザがブックマークをクリックすると、閲覧状態復元モジュールに遷移し、ブックマークしたWebページを開いた上で閲覧状態を復元する。
ブックマークの削除やお気に入り登録、フォルダ分け、検索機能など、ブックマークアプリケーションで一般的に存在する機能も本モジュールで提供している。

\subsubsection{閲覧状態復元モジュール}
本項では閲覧状態復元モジュールについて説明する。
前項のブックマーク一覧モジュールで、ユーザが再度閲覧したいブックマークをクリックすると、閲覧状態復元モジュールが開く。

閲覧状態復元モジュールの機能の実装はWebViewControllerというコントローラーが担う。
WebViewControllerは、WKWebViewというiOSアプリ内専用のブラウザでブックマークしたWebページを表示する。
ブックマークが選択されると、WebViewControllerは保存時のスクロール位置/ページ長/ブラウザ/ズーム率および、WKWebView内のページ長/ズーム率などの情報から適切なスクロール位置を計算する。
この計算結果に基づいてWebページをスクロールすると、ブックマーク時点で画面上限に位置していたコンテンツが、WKWebViewの画面の上限にちょうど表示される。
このスクロール位置を計算するアルゴリズムは以下の通りである。

\begin{equation}
スクロール位置 = スクロール位置
\end{equation}

Webページの読み込みが完了すると、WebViewController内のwebView(\_:didFinish:)\cite{didFinish}というハンドラが呼び出される。
webView(\_:didFinish:)ハンドラは、閲覧状態の復元を司る関数で、スクロール位置と動画再生位置を設定する。
まず、webView(\_:didFinish:)ハンドラは、window.scrollToというAPIを利用して計算結果の分だけWebページをスクロールする。
その上で、Webページ内に動画が存在する場合は、videoタグのcurrentTimeに保存時の動画再生位置を設定する。
なお、保存時と同様、再生位置を復元するのはWebページ内のDOMの最上位の動画のみである。


\subsection{Chrome拡張機能実装}
本節では、Chrome拡張機能の実装について述べる。図\ref{}にChrome拡張機能の実装の全体像を示す。
各モジュールの役割はiOSアプリケーションと基本的に同様であるため、差分についてのみ説明する。

\subsubsection{認証モジュール}
本項では認証モジュールについて説明する。
ユーザが本拡張機能をChromeにインストールした後、本アプリケーションのアイコンをクリックすると、図\ref{}のような認証用のウィンドウが開く。
iOSアプリケーションと同様に、Chrome拡張機能でも本ウィンドウからメールアドレスか外部サービスを通じて会員登録・ログインできる。

\subsubsection{ブックマーク保存モジュール}
本項ではブックマーク保存モジュールについて説明する。
本アプリケーションのChrome拡張機能では、iOSアプリケーションで対応している2種類の復元に加えて、PDFのページ数の復元にも対応している。
本項では、Chrome拡張機能における基本的なブックマーク保存機能に加えて、PDFページ数の取得機能についても説明する。

ユーザが拡張機能のアイコンをクリックすると、図\ref{}のようなポップアップが表示される。
ユーザがブックマークしたいWebページを開いた状態でポップアップ内の”保存する”ボタンをクリックすると、ボタンに登録されていたイベントが発火する。

このイベントは、まずWebページ内から必要な情報を取得する。
具体的には、Chrome Extensionのchrome.tabs API等を利用してWebページのタイトルなどのメタデータを取得したり、HTMLのAPIを利用して閲覧状態を表すデータを取得する。
この時に取得する情報と使用するAPIを表\ref{tb:chrome-data-api}にまとめる。

\begin{table}[htbp]
  \label{tb:chrome-data-api}
  \caption{ブックマーク保存モジュールで取得するデータ}
  \begin{center}
    \begin{tabular}{|l|l|l|}
    \hline
    取得するデータ & 型 & API \\ \hline
    URL & String & chrome.tabs.title \\ \hline
    ページタイトル & String & ca \\ \hline
    スクロール位置(縦) & Int & document.documentElement.scrollTop \\ \hline
    スクロール位置(横) & Int & document.documentElement.scrollLeft \\ \hline
    ページ長(縦) & Int & document.documentElement.scrollHeight \\ \hline
    ページ長(横) & Int & document.documentElement.scrollWidth \\ \hline
    動画再生位置 & Int & document.getElementsByTagName('video')[0].currentTime \\ \hline
    サムネイル画像URL & String & ca \\ \hline
    ズーム率 & Int & ca \\ \hline
    \end{tabular}
  \end{center}
\end{table}

上記のデータの取得が成功すると、Chrome拡張機能は取得したデータをサーバに送信する。

ユーザがWeb上にホスティングされているPDFを保存すると、本アプリケーションはURL等の基本情報を取得した上で、ブラウザの画面のキャプチャを撮影し、ストレージに保存する。
キャプチャには、というAPIを利用し、Chromeに表示されている画面を撮影する。
サーバ側では、ストレージにファイルがアップロードされたことをトリガーとして、画面キャプチャからOCRを用いてPDFのページ数を取得し、非同期的にデータベースに保存する。
なお、ユーザが保存を試みたWebページがPDFであることの判定には、URLの拡張子を用いている。

また、プライバシーの確保のため、画面キャプチャ時には図\ref{}のようなアラートを表示した上で、ユーザがオプトアウトできるようになっている。
保存した画面キャプチャはページ数を取得した後、自動的に削除される。

図\ref{}にChrome拡張機能におけるブックマーク保存モジュールの全体像を示す。

\subsubsection{一覧モジュール}
本項ではブックマーク一覧モジュールについて説明する。
Chrome拡張では、保存したブックマークを確認できる画面を2種類用意している。

1つ目は、図\ref{}に示した、拡張機能のアイコンをクリックすると表示されるポップアップである。
ポップアップでは、保存したブックマークのうち最新の5つを表示する。

2つ目は、図\ref{}に示した、ブックマークをすべて一覧できる画面である。
上記のポップアップで”保存済みのコンテンツ一覧”というリンクを押すと、新しいタブが開き、この画面が表示される。
本画面では、iOSアプリケーションと同様にブックマークの削除やお気に入り登録・フォルダ分類・検索などの機能を提供している。
本画面は、HTML/CSSに加えて、アニメーションのためにjQuery\cite{}・Bootstrap\cite{}・Popper.js\cite{}等のライブラリを利用して実装している。

% https://jquery.com/
% https://getbootstrap.jp/
% https://popper.js.org/

\subsubsection{閲覧状態復元モジュール}
本項では閲覧状態復元モジュールについて説明する。
前項のブックマーク一覧モジュールで、ユーザが再度閲覧したいブックマークをクリックすると、それぞれのブックマークに登録されていたイベントが発火する。
このイベントは、まずChromeのtabsAPIのcreateメソッドを呼びだして新しいタブを開く。そして、そのタブでユーザが選択したWebページを表示する。
加えて、本イベントはChromeのruntimeAPI\cite{}を利用してバックグラウンドスクリプト\cite{}にメッセージを送信する。
バックグラウンドスクリプトとは、ブラウザブラウザに関するイベントを監視し、処理を行うためのイベントベースのプログラムである\cite{}。
このメッセージを受信すると、バックグラウンドページで適切なスクロール量を計算する。
この計算に用いるアルゴリズムはiOSアプリケーションの閲覧状態復元モジュールの項\ref{}で説明したものと同様である。
本アプリケーションは計算結果に基づいてページをスクロールし、動画が存在する場合は再生位置を復旧する。
スクロール位置と動画再生位置の設定に用いるAPIも、iOSアプリケーションの閲覧状態復元モジュールの項\ref{}で説明したものと同様である。

なお、PDFについては、サーバ側で設定したURLを開くだけでブラウザ側が自動的にページ数を復元する。

\section{サーバ側実装}
サーバ側はWebAPIと、PDFからページ数を抽出するためのAWS Lambdaであり、それぞれRuby on Rails、Golangを用いて実装した。
WebAPIについては、認証関連API・ブックマーク関連API・フォルダ関連APIの3種類のAPIの実装について説明する。
その後、AWS Lambdaの実装について述べる。

\subsection{WebAPI}
\begin{itemize}
  \item WebAPIの実装について説明する。
\end{itemize}

\subsubsection{認証関連API}

\subsubsection{ブックマーク関連API}

% コンテンツの種類を判定
% 保存日の付与
% 共有用URLを生成

\subsubsection{フォルダ関連API}

\subsection{PDFからページ数を抽出する機能}
本項では、PDFからページ数を抽出し、ブックマークとともに保存する機能について説明する。


% 保存時にキャプチャを撮る→ストレージに保存→LambdaからtextractのAPIを呼び出し、キャプチャ内の文字を抽出する→抽出した文字からページ数を撮る→ブックマークに保存する。
% 図で流れを説明する。

\section{まとめ}
本章では、Web-Snapshotシステムの実装について述べた。
次章では、本システムを利用しいて実際にWebページをブックマークし、閲覧状態の復元を評価する。